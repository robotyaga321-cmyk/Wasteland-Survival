<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kingdom Evolution</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --grass: #4caf50; --wood-dark: #5d4037; --panel: #fffbe6; --gold: #f1c40f; }
        
        body { 
            margin: 0; background: var(--grass); font-family: 'Segoe UI', sans-serif; 
            overflow: hidden; color: var(--wood-dark); user-select: none;
        }

        /* –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Ä–µ—Å—É—Ä—Å–æ–≤ */
        .top-bar { 
            position: absolute; top: 50px; left: 0; width: 100%; 
            display: flex; justify-content: center; gap: 15px; z-index: 10; 
        }
        .res-item { 
            background: rgba(0,0,0,0.7); color: white; padding: 8px 15px; 
            border-radius: 20px; font-weight: bold; border: 1px solid rgba(255,255,255,0.2);
            display: flex; align-items: center; gap: 5px; min-width: 70px;
        }

        /* –ö–∞—Ä—Ç–∞ –∏ —Å–µ—Ç–∫–∞ */
        #map { width: 100vw; height: 100vh; position: relative; }
        
        .building-slot { 
            position: absolute; width: 90px; height: 90px; 
            background: rgba(255,255,255,0.15); border: 2px dashed rgba(255,255,255,0.4); 
            border-radius: 20px; display: flex; flex-direction: column;
            align-items: center; justify-content: center; transition: 0.2s;
        }
        .building-slot:active { transform: scale(0.95); }

        /* –ó–∞–º–æ–∫ */
        .castle-main { border: none; background: none; z-index: 5; }

        /* –ö–Ω–æ–ø–∫–∏ –º–µ–Ω—é */
        .ui-btn { 
            position: absolute; bottom: 30px; width: 65px; height: 65px; 
            background: #a1887f; border: 4px solid var(--wood-dark); border-radius: 50%;
            display: flex; align-items: center; justify-content: center; font-size: 30px; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); z-index: 20;
        }
        .btn-bag { right: 20px; }
        .btn-stats { left: 20px; }

        /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ */
        .overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.8); display: none; align-items: center; 
            justify-content: center; z-index: 100; 
        }
        .window { 
            background: var(--panel); width: 85%; border-radius: 30px; 
            padding: 25px; border: 6px solid #d7ccc8; text-align: center;
            box-shadow: 0 10px 0 #bcaaa4; animation: pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes pop { from { transform: scale(0.5); } to { transform: scale(1); } }

        .card { 
            background: white; border-radius: 15px; padding: 12px; margin-bottom: 10px;
            display: flex; align-items: center; justify-content: space-between; border: 1px solid #ddd;
        }
        .action-btn { 
            background: var(--grass); color: white; border: none; padding: 10px 15px; 
            border-radius: 10px; font-weight: bold; 
        }
        .delete-btn { background: #e53935; width: 100%; margin-top: 15px; }

        .lvl-badge { 
            background: #ff9800; color: white; padding: 2px 8px; border-radius: 10px;
            font-size: 12px; position: absolute; top: -10px; border: 2px solid white;
        }
    </style>
</head>
<body>

    <div class="top-bar">
        <div class="res-item">üåæ <span id="food">0</span></div>
        <div class="res-item">ü™µ <span id="wood">0</span></div>
        <div class="res-item">üåü <span id="stars">0</span></div>
    </div>

    <div id="map">
        <div class="building-slot castle-main" style="top:25%; left:38%;" onclick="openCastleMenu()">
            <div class="lvl-badge" id="castle-lvl-tag">–£—Ä.1</div>
            <div style="font-size: 50px;">üè∞</div>
            <div style="font-size: 12px; font-weight: bold;">–ó–ê–ú–û–ö</div>
        </div>
        
        <div id="slot1" class="building-slot" style="top:50%; left:12%;" onclick="openSlotMenu('slot1')">+</div>
        <div id="slot2" class="building-slot" style="top:50%; left:62%;" onclick="openSlotMenu('slot2')">+</div>
        <div id="slot3" class="building-slot" style="top:70%; left:38%;" onclick="openSlotMenu('slot3')">+</div>
    </div>

    <div class="ui-btn btn-bag" onclick="openShop()">üéí</div>
    <div class="ui-btn btn-stats" onclick="tg.showAlert('–í–µ—Ä—Å–∏—è 1.5: –ö–æ—Ä–æ–ª–µ–≤—Å—Ç–≤–æ —Ä–∞—Å—Ç–µ—Ç!')">üìä</div>

    <div id="modal" class="overlay">
        <div class="window">
            <h2 id="win-title" style="margin-top:0">–ú–µ–Ω—é</h2>
            <div id="win-content"></div>
            <br>
            <button class="action-btn" style="background:#90a4ae" onclick="closeWin()">–ó–ê–ö–†–´–¢–¨</button>
        </div>
    </div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    // –°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã
    let state = JSON.parse(localStorage.getItem('king_save')) || {
        food: 100, wood: 100, stars: 0,
        castleLvl: 1,
        slots: {
            slot1: { type: null, lvl: 0 },
            slot2: { type: null, lvl: 0 },
            slot3: { type: null, lvl: 0 }
        }
    };

    // –¢–∞–π–º–µ—Ä –¥–æ–±—ã—á–∏
    setInterval(() => {
        Object.values(state.slots).forEach(s => {
            if(s.type === 'farm') state.food += s.lvl * 3;
            if(s.type === 'mine') state.wood += s.lvl * 3;
        });
        refreshUI();
    }, 4000);

    function openSlotMenu(id) {
        const s = state.slots[id];
        const content = document.getElementById('win-content');
        const title = document.getElementById('win-title');
        
        if(!s.type) {
            title.innerText = "–ü–æ—Å—Ç—Ä–æ–π–∫–∞";
            content.innerHTML = `
                <div class="card"><span>üåæ –§–µ—Ä–º–∞</span><button class="action-btn" onclick="build('${id}','farm')">50 ü™µ</button></div>
                <div class="card"><span>ü™µ –õ–µ—Å–æ–ø–∏–ª–∫–∞</span><button class="action-btn" onclick="build('${id}','mine')">50 üåæ</button></div>
            `;
        } else {
            title.innerText = (s.type === 'farm' ? "–§–µ—Ä–º–∞" : "–õ–µ—Å–æ–ø–∏–ª–∫–∞");
            let upCost = (s.lvl + 1) * 80;
            content.innerHTML = `
                <p>–£—Ä–æ–≤–µ–Ω—å: ${s.lvl} | –≠—Ñ—Ñ–µ–∫—Ç: +${s.lvl * 3}/—Ü–∏–∫–ª</p>
                <button class="action-btn" style="width:100%" onclick="upgrade('${id}', ${upCost})">–£–õ–£–ß–®–ò–¢–¨ (${upCost})</button>
                <button class="action-btn delete-btn" onclick="destroy('${id}')">–°–ù–ï–°–¢–ò (-50%)</button>
            `;
        }
        document.getElementById('modal').style.display = "flex";
    }

    function openCastleMenu() {
        const title = document.getElementById('win-title');
        const content = document.getElementById('win-content');
        title.innerText = "–ó–∞–º–æ–∫";
        let upCost = state.castleLvl * 250;
        content.innerHTML = `
            <p>–£—Ä–æ–≤–µ–Ω—å –ó–∞–º–∫–∞ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –º–∞–∫—Å. —É—Ä–æ–≤–µ–Ω—å –¥—Ä—É–≥–∏—Ö –∑–¥–∞–Ω–∏–π.</p>
            <button class="action-btn" style="width:100%" onclick="upgradeCastle(${upCost})">–£–õ–£–ß–®–ò–¢–¨ –î–û –£–†.${state.castleLvl+1}<br>(${upCost} üåæ & ü™µ)</button>
        `;
        document.getElementById('modal').style.display = "flex";
    }

    function build(id, type) {
        let cost = 50;
        let res = (type === 'farm') ? 'wood' : 'food';
        if(state[res] >= cost) {
            state[res] -= cost;
            state.slots[id] = { type: type, lvl: 1 };
            tg.HapticFeedback.notificationOccurred('success');
            closeWin(); refreshUI();
        } else { tg.showAlert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ä–µ—Å—É—Ä—Å–æ–≤!"); }
    }

    function upgrade(id, cost) {
        if(state.slots[id].lvl >= state.castleLvl) {
            tg.showAlert("–°–Ω–∞—á–∞–ª–∞ —É–ª—É—á—à–∏ –ó–∞–º–æ–∫!");
            return;
        }
        if(state.wood >= cost) {
            state.wood -= cost;
            state.slots[id].lvl++;
            tg.HapticFeedback.impactOccurred('medium');
            closeWin(); refreshUI();
        } else { tg.showAlert("–ú–∞–ª–æ –¥–µ—Ä–µ–≤–∞!"); }
    }

    function upgradeCastle(cost) {
        if(state.food >= cost && state.wood >= cost) {
            state.food -= cost;
            state.wood -= cost;
            state.castleLvl++;
            closeWin(); refreshUI();
        } else { tg.showAlert("–ú–∞–ª–æ —Ä–µ—Å—É—Ä—Å–æ–≤ –¥–ª—è –ó–∞–º–∫–∞!"); }
    }

    function destroy(id) {
        if(confirm("–°–Ω–µ—Å—Ç–∏ –∑–¥–∞–Ω–∏–µ?")) {
            state.slots[id] = { type: null, lvl: 0 };
            state.wood += 25;
            closeWin(); refreshUI();
        }
    }

    function openShop() {
        const title = document.getElementById('win-title');
        const content = document.getElementById('win-content');
        title.innerText = "–ú–∞–≥–∞–∑–∏–Ω –ó–≤–µ–∑–¥";
        content.innerHTML = `
            <div class="card"><span>‚≠ê 2000 ü™µ</span><button class="action-btn" style="background:var(--gold); color:black" onclick="buyRes('wood')">5 üåü</button></div>
            <div class="card"><span>‚≠ê 2000 üåæ</span><button class="action-btn" style="background:var(--gold); color:black" onclick="buyRes('food')">5 üåü</button></div>
        `;
        document.getElementById('modal').style.display = "flex";
    }

    function buyRes(res) {
        // –ó–¥–µ—Å—å –±—É–¥–µ—Ç –≤—ã–∑–æ–≤ –ø–ª–∞—Ç–µ–∂–∞ –¢–µ–ª–µ–≥—Ä–∞–º. –ü–æ–∫–∞ –ø—Ä–æ—Å—Ç–æ –¥–æ–±–∞–≤–ª—è–µ–º.
        state[res] += 2000;
        tg.showAlert("–†–µ—Å—É—Ä—Å—ã –ø–æ–ª—É—á–µ–Ω—ã!");
        refreshUI();
    }

    function closeWin() { document.getElementById('modal').style.display = "none"; }

    function refreshUI() {
        localStorage.setItem('king_save', JSON.stringify(state));
        document.getElementById('food').innerText = Math.floor(state.food);
        document.getElementById('wood').innerText = Math.floor(state.wood);
        document.getElementById('castle-lvl-tag').innerText = "–£—Ä." + state.castleLvl;
        
        for(let id in state.slots) {
            let s = state.slots[id];
            let el = document.getElementById(id);
            if(s.type) {
                let icon = (s.type === 'farm') ? 'üåæ' : 'ü™ö';
                el.innerHTML = `<div class="lvl-badge">–£—Ä.${s.lvl}</div><div style="font-size:40px">${icon}</div>`;
                el.style.background = "white";
                el.style.border = "none";
            } else {
                el.innerHTML = "+";
                el.style.background = "rgba(255,255,255,0.15)";
                el.style.border = "2px dashed rgba(255,255,255,0.4)";
            }
        }
    }

    refreshUI();
</script>
</body>
</html>
