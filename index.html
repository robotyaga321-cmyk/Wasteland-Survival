<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>My Kingdom</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --bg: #4caf50; --panel: #fffbe6; --brown: #5d4037; }
        body { margin: 0; background: var(--bg); font-family: sans-serif; overflow: hidden; color: var(--brown); }

        .header { position: absolute; top: 60px; left: 10px; right: 10px; display: flex; gap: 10px; z-index: 10; }
        .res { background: rgba(0,0,0,0.6); color: white; padding: 6px 12px; border-radius: 20px; font-size: 14px; display: flex; align-items: center; gap: 5px; }

        #village { width: 100vw; height: 100vh; position: relative; }
        
        .slot { 
            position: absolute; width: 80px; height: 80px; 
            background: rgba(255,255,255,0.3); border: 2px dashed white; 
            border-radius: 15px; display: flex; align-items: center; justify-content: center; font-size: 40px; 
        }

        .bag-btn { 
            position: absolute; bottom: 30px; right: 20px; width: 60px; height: 60px; 
            background: #a1887f; border-radius: 50%; border: 4px solid var(--brown); 
            display: flex; align-items: center; justify-content: center; font-size: 30px; z-index: 20; 
        }

        .modal { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; z-index: 100; 
        }
        .modal-box { background: var(--panel); width: 85%; border-radius: 20px; padding: 20px; border: 4px solid #d7ccc8; text-align: center; }
        
        .build-card { 
            background: white; border: 2px solid #ddd; border-radius: 12px; 
            padding: 10px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; 
        }
        .btn { background: #4caf50; color: white; border: none; padding: 8px 12px; border-radius: 8px; font-weight: bold; }
        .btn-del { background: #e53935; margin-top: 10px; width: 100%; }
        .lvl-tag { background: #ff9800; color: white; padding: 2px 6px; border-radius: 5px; font-size: 12px; position: absolute; top: -10px; }
    </style>
</head>
<body>

    <div class="header">
        <div class="res">üåæ <span id="food">0</span></div>
        <div class="res">ü™µ <span id="wood">0</span></div>
    </div>

    <div id="village">
        <div class="slot" style="top:30%; left:40%; border:none;">üè∞</div>
        <div id="slot1" class="slot" style="top:50%; left:20%;" onclick="openMenu('slot1')">+</div>
        <div id="slot2" class="slot" style="top:50%; left:60%;" onclick="openMenu('slot2')">+</div>
    </div>

    <div class="bag-btn" onclick="openBag()">üéí</div>

    <div id="modal" class="modal">
        <div class="modal-box">
            <h2 id="m-title">–ó–∞–≥–æ–ª–æ–≤–æ–∫</h2>
            <div id="m-content"></div>
            <br>
            <button class="btn" style="background:#777" onclick="closeM()">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    let saved = JSON.parse(localStorage.getItem('my_rpg_save'));
    let state = saved || {
        food: 100, wood: 80,
        slots: { slot1: { type: null, lvl: 0 }, slot2: { type: null, lvl: 0 } }
    };

    let currentSlot = '';

    setInterval(() => {
        if(state.slots.slot1.type === 'farm') state.food += state.slots.slot1.lvl * 2;
        if(state.slots.slot1.type === 'sawmill') state.wood += state.slots.slot1.lvl * 2;
        if(state.slots.slot2.type === 'farm') state.food += state.slots.slot2.lvl * 2;
        if(state.slots.slot2.type === 'sawmill') state.wood += state.slots.slot2.lvl * 2;
        saveAndUI();
    }, 3000);

    function openMenu(id) {
        currentSlot = id;
        let s = state.slots[id];
        let content = document.getElementById('m-content');
        
        if(!s.type) {
            document.getElementById('m-title').innerText = "–ü–æ—Å—Ç—Ä–æ–∏—Ç—å";
            content.innerHTML = `
                <div class="build-card"><span>üöú –§–µ—Ä–º–∞</span> <button class="btn" onclick="buy('farm')">50 ü™µ</button></div>
                <div class="build-card"><span>ü™ö –õ–µ—Å–æ–ø–∏–ª–∫–∞</span> <button class="btn" onclick="buy('sawmill')">50 ü™µ</button></div>
            `;
        } else {
            document.getElementById('m-title').innerText = "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ";
            let cost = (s.lvl + 1) * 100;
            content.innerHTML = `
                <p>–ó–¥–∞–Ω–∏–µ: ${s.type === 'farm' ? '–§–µ—Ä–º–∞' : '–õ–µ—Å–æ–ø–∏–ª–∫–∞'} (–£—Ä. ${s.lvl})</p>
                <button class="btn" onclick="upgrade('${id}', ${cost})">–£–ª—É—á—à–∏—Ç—å –∑–∞ ${cost} ü™µ</button>
                <button class="btn btn-del" onclick="deleteBuilding('${id}')">‚ùå –°–Ω–µ—Å—Ç–∏ (–í–µ—Ä–Ω—É—Ç—å 25 ü™µ)</button>
            `;
        }
        document.getElementById('modal').style.display = "flex";
    }

    function buy(type) {
        if(state.wood >= 50) {
            state.wood -= 50;
            state.slots[currentSlot] = { type: type, lvl: 1 };
            closeM(); saveAndUI();
        } else { alert("–ú–∞–ª–æ –¥–µ—Ä–µ–≤–∞!"); }
    }

    function upgrade(id, cost) {
        if(state.wood >= cost) {
            state.wood -= cost;
            state.slots[id].lvl++;
            closeM(); saveAndUI();
        } else { alert("–ù—É–∂–Ω–æ –±–æ–ª—å—à–µ –¥–µ—Ä–µ–≤–∞!"); }
    }

    // –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –£–î–ê–õ–ï–ù–ò–ï
    function deleteBuilding(id) {
        if(confirm("–¢–æ—á–Ω–æ —Å–Ω–µ—Å—Ç–∏ –∑–¥–∞–Ω–∏–µ? –í–µ—Ä–Ω–µ—Ç—Å—è 50% —Ä–µ—Å—É—Ä—Å–æ–≤.")) {
            state.slots[id] = { type: null, lvl: 0 }; // –û–±–Ω—É–ª—è–µ–º —Å–ª–æ—Ç
            state.wood += 25; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º 25 –¥–µ—Ä–µ–≤–∞ (50% –æ—Ç 50)
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤–Ω–µ—à–Ω–∏–π –≤–∏–¥ —Å–ª–æ—Ç–∞
            let slotEl = document.getElementById(id);
            slotEl.innerHTML = "+";
            slotEl.style.background = "rgba(255,255,255,0.3)";
            slotEl.style.border = "2px dashed white";

            closeM();
            saveAndUI();
            if(tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('warning');
        }
    }

    function openBag() {
        document.getElementById('m-title').innerText = "–ú–∞–≥–∞–∑–∏–Ω –ó–≤—ë–∑–¥";
        document.getElementById('m-content').innerHTML = `
            <div class="build-card"><span>‚≠ê +500 –î–µ—Ä–µ–≤–∞</span> <button class="btn" onclick="tg.sendData('buy_wood')">5 üåü</button></div>
        `;
        document.getElementById('modal').style.display = "flex";
    }

    function closeM() { document.getElementById('modal').style.display = "none"; }

    function saveAndUI() {
        localStorage.setItem('my_rpg_save', JSON.stringify(state));
        document.getElementById('food').innerText = Math.floor(state.food);
        document.getElementById('wood').innerText = Math.floor(state.wood);
        
        for(let id in state.slots) {
            let s = state.slots[id];
            let slotElement = document.getElementById(id);
            if(s.type && slotElement) {
                // –ï—Å–ª–∏ —Ç—ã –¥–æ–±–∞–≤–∏–ª –∫–∞—Ä—Ç–∏–Ω–∫–∏, –∑–∞–º–µ–Ω–∏ —ç–º–æ–¥–∑–∏ –Ω–∏–∂–µ –Ω–∞ <img src="assets/...">
let icon = '';
if (s.type === 'farm') {
    // –ó–ê–ú–ï–ù–ò .png –Ω–∞ .jpg (–∏–ª–∏ –Ω–∞ .jpeg, –µ—Å–ª–∏ —Ñ–∞–π–ª —Ç–∞–∫ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è)
    icon = '<img src="assets/farm.jpg" width="60" style="pointer-events:none;">';
} else if (s.type === 'sawmill') {
    // –ï—Å–ª–∏ –ª–µ—Å–æ–ø–∏–ª–∫–∞ —Ç–æ–∂–µ jpg - –º–µ–Ω—è–µ–º –∏ —Ç—É—Ç
    icon = '<img src="assets/sawmill.jpg" width="60" style="pointer-events:none;">';
}

                slotElement.innerHTML = `<div class="lvl-tag">–£—Ä.${s.lvl}</div> ${icon}`;
                slotElement.style.background = "white";
                slotElement.style.border = "none";
            }
        }
    }

    saveAndUI();
    function saveAndUI() {
    localStorage.setItem('my_rpg_save', JSON.stringify(state));
    document.getElementById('food').innerText = Math.floor(state.food);
    document.getElementById('wood').innerText = Math.floor(state.wood);
    
    for(let id in state.slots) {
        let s = state.slots[id];
        let slotElement = document.getElementById(id);
        if(s.type && slotElement) {
            
            // –í–°–¢–ê–í–¨ –°–í–û–ò –ü–†–Ø–ú–´–ï –°–°–´–õ–ö–ò –° –ì–ò–¢–•–ê–ë–ê –ú–ï–ñ–î–£ –ö–ê–í–´–ß–ï–ö:
            let farmImg = "assets/farm.jpg"; 
            let sawImg = "assets/sawmill.jpg";

            let icon = s.type === 'farm' ? 
                `<img src="${farmImg}" width="65" alt="–§–ï–†–ú–ê" onerror="this.parentElement.innerHTML+='‚ùå'">` : 
                `<img src="${sawImg}" width="65" alt="–ü–ò–õ–ê" onerror="this.parentElement.innerHTML+='‚ùå'">`;
            
            slotElement.innerHTML = `<div class="lvl-tag">–£—Ä.${s.lvl}</div> ${icon}`;
            slotElement.style.background = "none"; // –£–±–∏—Ä–∞–µ–º –±–µ–ª—ã–π —Ñ–æ–Ω, —á—Ç–æ–±—ã –±—ã–ª–æ –∫—Ä–∞—Å–∏–≤–æ
            slotElement.style.border = "none";
        }
    }
}

</script>
</body>
</html>
