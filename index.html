<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kingdom Craft</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --bg: #4caf50; --panel: #fffbe6; --brown: #5d4037; --red: #e53935; }
        body { margin: 0; background: var(--bg); font-family: 'Segoe UI', sans-serif; overflow: hidden; color: var(--brown); }

        /* –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å */
        .header { position: absolute; top: 60px; left: 10px; right: 10px; display: flex; gap: 10px; z-index: 10; }
        .res { background: rgba(0,0,0,0.7); color: white; padding: 8px 15px; border-radius: 20px; font-size: 16px; display: flex; align-items: center; gap: 8px; border: 1px solid rgba(255,255,255,0.2); }

        /* –ö–∞—Ä—Ç–∞ */
        #village { width: 100vw; height: 100vh; position: relative; background: radial-gradient(#81c784 10%, transparent 20%); background-size: 30px 30px; }
        
        .slot { 
            position: absolute; width: 90px; height: 90px; 
            background: rgba(255,255,255,0.2); border: 2px dashed rgba(255,255,255,0.5); 
            border-radius: 15px; display: flex; align-items: center; justify-content: center; font-size: 40px; 
            transition: 0.2s;
        }

        /* –ö–Ω–æ–ø–∫–∞ –°—É–º–∫–∏ */
        .bag-btn { 
            position: absolute; bottom: 30px; right: 20px; width: 70px; height: 70px; 
            background: #a1887f; border-radius: 50%; border: 4px solid var(--brown); 
            display: flex; align-items: center; justify-content: center; font-size: 35px; z-index: 20; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ */
        .modal { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.85); display: none; align-items: center; justify-content: center; z-index: 100; 
        }
        .modal-box { background: var(--panel); width: 85%; border-radius: 25px; padding: 25px; border: 5px solid #d7ccc8; text-align: center; box-shadow: 0 10px 0 #bcaaa4; }
        
        .build-card { 
            background: white; border: 2px solid #ddd; border-radius: 15px; 
            padding: 15px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; 
        }
        .btn { background: #4caf50; color: white; border: none; padding: 10px 20px; border-radius: 10px; font-weight: bold; cursor: pointer; }
        .btn-del { background: var(--red); margin-top: 15px; width: 100%; }
        
        .lvl-tag { 
            background: #ff9800; color: white; padding: 3px 8px; border-radius: 8px; 
            font-size: 12px; position: absolute; top: -12px; font-weight: bold; border: 2px solid white;
        }

        img { pointer-events: none; object-fit: contain; }
    </style>
</head>
<body>

    <div class="header">
        <div class="res">üåæ <span id="food">0</span></div>
        <div class="res">ü™µ <span id="wood">0</span></div>
    </div>

    <div id="village">
        <div class="slot" style="top:25%; left:38%; border:none; background:none;">üè∞</div>
        
        <div id="slot1" class="slot" style="top:50%; left:15%;" onclick="openMenu('slot1')">+</div>
        <div id="slot2" class="slot" style="top:50%; left:65%;" onclick="openMenu('slot2')">+</div>
    </div>

    <div class="bag-btn" onclick="openBag()">üéí</div>

    <div id="modal" class="modal">
        <div class="modal-box">
            <h2 id="m-title" style="margin-top:0">–ú–µ–Ω—é</h2>
            <div id="m-content"></div>
            <br>
            <button class="btn" style="background:#90a4ae" onclick="closeM()">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    // 1. –ó–ê–ì–†–£–ó–ö–ê –ò –°–û–•–†–ê–ù–ï–ù–ò–ï
    let saved = JSON.parse(localStorage.getItem('my_kingdom_save'));
    let state = saved || {
        food: 100, wood: 80,
        slots: { 
            slot1: { type: null, lvl: 0 }, 
            slot2: { type: null, lvl: 0 } 
        }
    };

    let currentSlot = '';

    // 2. –î–û–•–û–î –†–ï–°–£–†–°–û–í (–ö–∞–∂–¥—ã–µ 3 —Å–µ–∫—É–Ω–¥—ã)
    setInterval(() => {
        Object.values(state.slots).forEach(s => {
            if(s.type === 'farm') state.food += s.lvl * 2;
            if(s.type === 'sawmill') state.wood += s.lvl * 2;
        });
        saveAndUI();
    }, 3000);

    // 3. –û–¢–ö–†–´–¢–ò–ï –ú–ï–ù–Æ
    function openMenu(id) {
        currentSlot = id;
        let s = state.slots[id];
        let content = document.getElementById('m-content');
        
        if(!s.type) {
            document.getElementById('m-title').innerText = "–ü–æ—Å—Ç—Ä–æ–∏—Ç—å";
            content.innerHTML = `
                <div class="build-card"><span>üöú –§–µ—Ä–º–∞</span> <button class="btn" onclick="buy('farm')">50 ü™µ</button></div>
                <div class="build-card"><span>ü™ö –õ–µ—Å–æ–ø–∏–ª–∫–∞</span> <button class="btn" onclick="buy('sawmill')">50 ü™µ</button></div>
            `;
        } else {
            document.getElementById('m-title').innerText = "–£–ª—É—á—à–µ–Ω–∏–µ";
            let upgradeCost = (s.lvl + 1) * 100;
            content.innerHTML = `
                <p style="font-size:18px">–£—Ä–æ–≤–µ–Ω—å –∑–¥–∞–Ω–∏—è: <b>${s.lvl}</b></p>
                <button class="btn" onclick="upgrade('${id}', ${upgradeCost})">–£–ª—É—á—à–∏—Ç—å –∑–∞ ${upgradeCost} ü™µ</button>
                <button class="btn btn-del" onclick="deleteBuilding('${id}')">‚ùå –°–Ω–µ—Å—Ç–∏ (–í–µ—Ä–Ω—É—Ç—å 25 ü™µ)</button>
            `;
        }
        document.getElementById('modal').style.display = "flex";
        tg.HapticFeedback.impactOccurred('medium');
    }

    // 4. –ü–û–ö–£–ü–ö–ê, –£–õ–£–ß–®–ï–ù–ò–ï –ò –£–î–ê–õ–ï–ù–ò–ï
    function buy(type) {
        if(state.wood >= 50) {
            state.wood -= 50;
            state.slots[currentSlot] = { type: type, lvl: 1 };
            closeM(); saveAndUI();
            tg.HapticFeedback.notificationOccurred('success');
        } else { tg.showAlert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–µ—Ä–µ–≤–∞!"); }
    }

    function upgrade(id, cost) {
        if(state.wood >= cost) {
            state.wood -= cost;
            state.slots[id].lvl++;
            closeM(); saveAndUI();
            tg.HapticFeedback.notificationOccurred('success');
        } else { tg.showAlert("–ù—É–∂–Ω–æ –±–æ–ª—å—à–µ –¥–µ—Ä–µ–≤–∞!"); }
    }

    function deleteBuilding(id) {
        if(confirm("–°–Ω–µ—Å—Ç–∏ –∑–¥–∞–Ω–∏–µ –∏ –≤–µ—Ä–Ω—É—Ç—å 50% —Ä–µ—Å—É—Ä—Å–æ–≤?")) {
            state.slots[id] = { type: null, lvl: 0 };
            state.wood += 25;
            // –°–±—Ä–æ—Å –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ —Å—Ç–∏–ª—è
            let el = document.getElementById(id);
            el.innerHTML = "+";
            el.style.background = "rgba(255,255,255,0.2)";
            el.style.border = "2px dashed rgba(255,255,255,0.5)";
            closeM(); saveAndUI();
            tg.HapticFeedback.notificationOccurred('warning');
        }
    }

    // 5. –ú–ê–ì–ê–ó–ò–ù –ó–í–Å–ó–î (–î–û–ù–ê–¢)
    function openBag() {
        document.getElementById('m-title').innerText = "–ú–∞–≥–∞–∑–∏–Ω –ó–≤—ë–∑–¥";
        document.getElementById('m-content').innerHTML = `
            <p>–ö—É–ø–∏—Ç—å —Ä–µ—Å—É—Ä—Å—ã –∑–∞ –ó–≤—ë–∑–¥—ã Telegram</p>
            <div class="build-card"><span>‚≠ê 1000 ü™µ</span> <button class="btn" style="background:#f1c40f; color:black" onclick="tg.sendData('buy_wood')">5 üåü</button></div>
            <div class="build-card"><span>‚≠ê 1000 üåæ</span> <button class="btn" style="background:#f1c40f; color:black" onclick="tg.sendData('buy_food')">5 üåü</button></div>
        `;
        document.getElementById('modal').style.display = "flex";
    }

    function closeM() { document.getElementById('modal').style.display = "none"; }

    // 6. –û–ë–ù–û–í–õ–ï–ù–ò–ï –≠–ö–†–ê–ù–ê –ò –ö–ê–†–¢–ò–ù–û–ö
    function saveAndUI() {
        localStorage.setItem('my_kingdom_save', JSON.stringify(state));
        document.getElementById('food').innerText = Math.floor(state.food);
        document.getElementById('wood').innerText = Math.floor(state.wood);
        
        for(let id in state.slots) {
            let s = state.slots[id];
            let slotElement = document.getElementById(id);
            if(s.type && slotElement) {
                // –ü–£–¢–¨ –ö –¢–í–û–ò–ú –ö–ê–†–¢–ò–ù–ö–ê–ú (–ü—Ä–æ–≤–µ—Ä—å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ .jpg –∏–ª–∏ .jpeg!)
                let imgFile = s.type === 'farm' ? 'farm.jpg' : 'sawmill.jpg';
                let imgPath = `assets/${imgFile}`;
                
                slotElement.innerHTML = `
                    <div class="lvl-tag">–£—Ä.${s.lvl}</div>
                    <img src="${imgPath}" width="80" height="80" 
                         onerror="this.style.display='none'; this.parentElement.innerHTML+='${s.type === 'farm' ? 'üöú' : 'ü™ö'}';">
                `;
                slotElement.style.background = "none";
                slotElement.style.border = "none";
            }
        }
    }

    saveAndUI();
</script>
</body>
</html>
