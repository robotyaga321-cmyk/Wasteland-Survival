<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Wasteland Survival RPG</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { margin: 0; background: #1a1a1a; overflow: hidden; font-family: 'Segoe UI', sans-serif; }
        canvas { display: block; touch-action: none; }
        
        /* –ü–∞–Ω–µ–ª—å –∏–≥—Ä–æ–∫–∞ —Å–≤–µ—Ä—Ö—É */
        .ui-top {
            position: absolute; top: 15px; left: 15px; right: 15px;
            display: flex; justify-content: space-between; pointer-events: none;
        }
        .stat-box {
            background: rgba(0,0,0,0.8); padding: 10px 15px;
            border-radius: 12px; border: 1px solid #333; color: #fff;
        }
        .res-val { color: #f1c40f; font-weight: bold; }

        /* –ö–Ω–æ–ø–∫–∞ –º–∞–≥–∞–∑–∏–Ω–∞ —Å–Ω–∏–∑—É */
        .shop-area {
            position: absolute; bottom: 30px; width: 100%;
            display: flex; justify-content: center;
        }
        .buy-btn {
            background: linear-gradient(180deg, #f1c40f 0%, #d35400 100%);
            border: none; padding: 15px 30px; border-radius: 50px;
            color: #000; font-weight: bold; font-size: 16px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5); cursor: pointer;
            pointer-events: auto;
        }
        .buy-btn:active { transform: scale(0.95); }
    </style>
</head>
<body>

<div class="ui-top">
    <div class="stat-box">üéí –†–µ—Å—É—Ä—Å—ã: <span id="res-count" class="res-val">0</span></div>
    <div class="stat-box">üë§ <span id="user-name">Player</span></div>
</div>

<canvas id="game"></canvas>

<div class="shop-area">
    <button class="buy-btn" onclick="requestPurchase()">‚ö° –ö–£–ü–ò–¢–¨ 100 –†–ï–°–£–†–°–û–í (5 üåü)</button>
</div>

<script>
      const tg = window.Telegram.WebApp;
    tg.expand();
    
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    const resDisplay = document.getElementById('res-count');
    
    document.getElementById('user-name').innerText = tg.initDataUnsafe.user?.first_name || "Survivor";

    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    let resources = parseInt(localStorage.getItem('rpg_res')) || 0;
    resDisplay.innerText = resources;

    let player = {
        x: canvas.width / 2, y: canvas.height / 2,
        targetX: canvas.width / 2, targetY: canvas.height / 2,
        size: 25, color: '#3498db', speed: 0.08, hp: 100
    };

    // –ú–∞—Å—Å–∏–≤—ã –¥–ª—è –∏–≥—Ä–æ–≤—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤
    let worldObjects = []; // –ö—É—Å—Ç—ã —Å —Ä–µ—Å—É—Ä—Å–∞–º–∏
    let enemies = [];      // –í—Ä–∞–≥–∏

    // –°–æ–∑–¥–∞–µ–º –∫—É—Å—Ç—ã —Ä–µ—Å—É—Ä—Å–æ–≤ –æ–¥–∏–Ω —Ä–∞–∑
    function spawnResources() {
        for(let i=0; i<15; i++) {
            worldObjects.push({
                x: Math.random() * canvas.width,
                y: Math.random() * canvas.height,
                collected: false
            });
        }
    }

    // –°–æ–∑–¥–∞–µ–º –≤—Ä–∞–≥–æ–≤
    function spawnEnemies() {
        for(let i=0; i<3; i++) {
            enemies.push({
                x: Math.random() * canvas.width,
                y: Math.random() * canvas.height,
                speed: 0.5 + Math.random()
            });
        }
    }

    function draw() {
        // 1. –§–æ–Ω
        ctx.fillStyle = '#1e272e';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // 2. –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤ (–ö—É—Å—Ç—ã)
        worldObjects.forEach(obj => {
            if(!obj.collected) {
                ctx.fillStyle = '#27ae60';
                ctx.beginPath();
                ctx.arc(obj.x, obj.y, 10, 0, Math.PI*2);
                ctx.fill();

                // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏—è (—Å–±–æ—Ä)
                let dist = Math.hypot(player.x - obj.x, player.y - obj.y);
                if(dist < 20) {
                    obj.collected = true;
                    resources += 10;
                    resDisplay.innerText = resources;
                    localStorage.setItem('rpg_res', resources);
                    if(tg.HapticFeedback) tg.HapticFeedback.impactOccurred('soft');
                }
            }
        });

        // 3. –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∏ AI –≤—Ä–∞–≥–æ–≤
        enemies.forEach(enemy => {
            // –í—Ä–∞–≥ –º–µ–¥–ª–µ–Ω–Ω–æ –∏–¥–µ—Ç –∫ –∏–≥—Ä–æ–∫—É
            let dx = player.x - enemy.x;
            let dy = player.y - enemy.y;
            let angle = Math.atan2(dy, dx);
            enemy.x += Math.cos(angle) * enemy.speed;
            enemy.y += Math.sin(angle) * enemy.speed;

            ctx.fillStyle = '#e74c3c';
            ctx.fillRect(enemy.x, enemy.y, 20, 20);

            // –£—Ä–æ–Ω –∏–≥—Ä–æ–∫—É
            if(Math.hypot(player.x - enemy.x, player.y - enemy.y) < 20) {
                player.hp -= 0.1; // –ü–ª–∞–≤–Ω–æ–µ —É–º–µ–Ω—å—à–µ–Ω–∏–µ HP
                if(player.hp < 0) {
                    alert("–í—ã –ø–æ–≥–∏–±–ª–∏! –†–µ—Å—É—Ä—Å—ã –ø–æ—Ç–µ—Ä—è–Ω—ã.");
                    resources = 0; player.hp = 100;
                    location.reload();
                }
            }
        });

        // 4. –î–≤–∏–∂–µ–Ω–∏–µ –∏–≥—Ä–æ–∫–∞
        player.x += (player.targetX - player.x) * player.speed;
        player.y += (player.targetY - player.y) * player.speed;

        // –†–∏—Å—É–µ–º –∏–≥—Ä–æ–∫–∞
        ctx.fillStyle = player.color;
        ctx.fillRect(player.x, player.y, player.size, player.size);

        // 5. –í–∏–Ω—å–µ—Ç–∫–∞ (—ç—Ñ—Ñ–µ–∫—Ç —Ç–µ–º–Ω–æ—Ç—ã –≤–æ–∫—Ä—É–≥)
        let gradient = ctx.createRadialGradient(
            player.x + 12, player.y + 12, 50, 
            player.x + 12, player.y + 12, 250
        );
        gradient.addColorStop(0, 'rgba(0,0,0,0)');
        gradient.addColorStop(1, 'rgba(0,0,0,0.8)');
        ctx.fillStyle = gradient;
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        requestAnimationFrame(draw);
    }

    window.addEventListener('pointerdown', (e) => {
        if (e.target.tagName === 'BUTTON') return;
        player.targetX = e.clientX - 12;
        player.targetY = e.clientY - 12;
    });

    function requestPurchase() {
        tg.sendData("buy_100_res");
    }

    spawnResources();
    spawnEnemies();
    draw();

    const tg = window.Telegram.WebApp;
    tg.expand();
    
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    const resDisplay = document.getElementById('res-count');
    
    // –ò–º—è –∏–≥—Ä–æ–∫–∞ –∏–∑ Telegram
    document.getElementById('user-name').innerText = tg.initDataUnsafe.user?.first_name || "Survivor";

    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    let resources = parseInt(localStorage.getItem('rpg_res')) || 0;
    resDisplay.innerText = resources;

    // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–≥—Ä–æ–∫–∞
    let player = {
        x: canvas.width / 2,
        y: canvas.height / 2,
        targetX: canvas.width / 2,
        targetY: canvas.height / 2,
        size: 30,
        color: '#3498db',
        speed: 0.1 // –ü–ª–∞–≤–Ω–æ—Å—Ç—å (—á–µ–º –º–µ–Ω—å—à–µ, —Ç–µ–º –º–µ–¥–ª–µ–Ω–Ω–µ–µ)
    };

    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –º–∏—Ä–∞
    function draw() {
        // –§–æ–Ω–æ–≤–∞—è –∑–∞–ª–∏–≤–∫–∞
        ctx.fillStyle = '#2c3e50';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // –†–∏—Å—É–µ–º —Å–µ—Ç–∫—É "–±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–≥–æ –º–∏—Ä–∞"
        ctx.strokeStyle = '#34495e';
        ctx.lineWidth = 1;
        const gridSize = 50;
        for (let x = 0; x < canvas.width; x += gridSize) {
            ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, canvas.height); ctx.stroke();
        }
        for (let y = 0; y < canvas.height; y += gridSize) {
            ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(canvas.width, y); ctx.stroke();
        }

        // –ü–ª–∞–≤–Ω–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ (Lerp)
        player.x += (player.targetX - player.x) * player.speed;
        player.y += (player.targetY - player.y) * player.speed;

        // –¢–µ–Ω—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
        ctx.fillStyle = 'rgba(0,0,0,0.3)';
        ctx.beginPath();
        ctx.ellipse(player.x + 15, player.y + 35, 15, 7, 0, 0, Math.PI * 2);
        ctx.fill();

        // –ü–µ—Ä—Å–æ–Ω–∞–∂
        ctx.fillStyle = player.color;
        ctx.shadowBlur = 15;
        ctx.shadowColor = player.color;
        ctx.fillRect(player.x, player.y, player.size, player.size);
        ctx.shadowBlur = 0; // –°–±—Ä–æ—Å —Ç–µ–Ω–∏ –¥–ª—è –¥—Ä—É–≥–∏—Ö –æ–±—ä–µ–∫—Ç–æ–≤

        requestAnimationFrame(draw);
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–∞ –ø–æ —ç–∫—Ä–∞–Ω—É
    window.addEventListener('pointerdown', (e) => {
        // –ß—Ç–æ–±—ã –∫–ª–∏–∫ –ø–æ –∫–Ω–æ–ø–∫–µ –Ω–µ –∑–∞—Å—Ç–∞–≤–ª—è–ª –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –∏–¥—Ç–∏ –∫ –Ω–µ–π
        if (e.target.tagName === 'BUTTON') return;

        player.targetX = e.clientX - player.size / 2;
        player.targetY = e.clientY - player.size / 2;
        
        if (tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
    });

    // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫—É–ø–∫–∏
    function requestPurchase() {
        if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('warning');
        
        // –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –±–æ—Ç—É. –ë–æ—Ç —É–≤–∏–¥–∏—Ç —ç—Ç–æ –∏ –ø—Ä–∏—à–ª–µ—Ç —Å—á–µ—Ç –Ω–∞ –ó–≤–µ–∑–¥—ã.
        tg.sendData("buy_100_res");
    }

    // –ü–æ–¥—Å—Ç—Ä–æ–π–∫–∞ –ø–æ–¥ —Ä–∞–∑–º–µ—Ä —ç–∫—Ä–∞–Ω–∞ –ø—Ä–∏ –ø–æ–≤–æ—Ä–æ—Ç–µ
    window.addEventListener('resize', () => {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
    });

    draw();
</script>
</body>
</html>
