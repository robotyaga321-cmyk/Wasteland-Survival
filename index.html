<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>–ü–µ—Å–æ—á–Ω–∏—Ü–∞: –ü—É—Ç—å –û–¥–∏–Ω–∞</title>
    <style>
        body { margin: 0; background: #0a0a0a; color: white; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; overflow: hidden; }
        canvas { display: block; }
        
        /* –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        .stat-box { position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.7); padding: 10px; border-radius: 10px; border: 1px solid #333; pointer-events: auto; }
        
        /* –ö–Ω–æ–ø–∫–∞ –ü–æ–≥–æ–≤–æ—Ä–∏—Ç—å */
        #talk-btn { 
            position: absolute; bottom: 180px; right: 30px; 
            width: 80px; height: 80px; background: #2ed573; 
            border-radius: 50%; display: none; align-items: center; 
            justify-content: center; font-weight: bold; pointer-events: auto;
            box-shadow: 0 0 15px rgba(46, 213, 115, 0.5);
        }

        /* –û–∫–Ω–æ –¥–∏–∞–ª–æ–≥–∞ */
        #dialog-box {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 90%; background: rgba(20, 20, 20, 0.95); border: 2px solid #444;
            border-radius: 15px; padding: 20px; display: none; pointer-events: auto;
        }

        /* –ú–∏–Ω–∏-–∫–∞—Ä—Ç–∞ */
        #minimap-cont { position: absolute; top: 10px; right: 10px; width: 120px; height: 120px; background: rgba(0,0,0,0.8); border: 2px solid #444; border-radius: 5px; }
        
        /* –î–∂–æ–π—Å—Ç–∏–∫ */
        #joy-base { position: absolute; bottom: 40px; left: 40px; width: 100px; height: 100px; background: rgba(255,255,255,0.1); border-radius: 50%; pointer-events: auto; }
        #joy-stick { position: absolute; top: 25px; left: 25px; width: 50px; height: 50px; background: rgba(255,255,255,0.4); border-radius: 50%; transition: 0.1s; }
    </style>
</head>
<body>

<div id="ui-layer">
    <div class="stat-box">‚ù§Ô∏è <span id="hp">100</span> | üí∞ <span id="gold">0</span></div>
    <div id="minimap-cont"><canvas id="minimap"></canvas></div>
    <div id="talk-btn" onclick="startTalk()">üó£Ô∏è</div>
    <div id="dialog-box">
        <b id="npc-name"></b><br><p id="npc-text"></p>
        <button onclick="closeDialog()" style="width:100%; padding:10px; background:#444; color:white; border:none; border-radius:5px;">–î–∞–ª–µ–µ</button>
    </div>
</div>

<div id="joy-base"><div id="joy-stick"></div></div>
<canvas id="gameCanvas"></canvas>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const mCanvas = document.getElementById('minimap');
const mCtx = mCanvas.getContext('2d');

canvas.width = window.innerWidth;
canvas.height = window.innerHeight;
mCanvas.width = 120; mCanvas.height = 120;

// –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –º–∏—Ä–∞
const WORLD_SIZE = 20000;
let player = { x: 10000, y: 10000, hp: 100, gold: 0, speed: 5 };
let entities = [
    { x: 10050, y: 10050, type: 'npc', color: '#2ed573', name: '–°—Ç–∞—Ä–µ–π—à–∏–Ω–∞ –≠–ª–¥–æ—Ä', textIndex: 0 },
    { x: 10300, y: 10200, type: 'enemy', color: '#ffcc00', hp: 30 },
    { x: 15000, y: 15000, type: 'boss', color: '#ff4757', hp: 500, size: 40 }
];

const npcData = {
    '–°—Ç–∞—Ä–µ–π—à–∏–Ω–∞ –≠–ª–¥–æ—Ä': [
        '–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é! –ß—Ç–æ–±—ã –≤—ã–∂–∏—Ç—å –≤ —ç—Ç–æ–º –º–∏—Ä–µ, –∏—Å–ø–æ–ª—å–∑—É–π –¥–∂–æ–π—Å—Ç–∏–∫. üïπÔ∏è',
        '–ü–æ–¥–æ–π–¥–∏ –∫ –≤—Ä–∞–≥–∞–º (–∂–µ–ª—Ç—ã–µ —Ç–æ—á–∫–∏), —á—Ç–æ–±—ã –∞—Ç–∞–∫–æ–≤–∞—Ç—å –∏—Ö! ‚öîÔ∏è',
        '–ù–∞ —é–≥–µ (–¥–∞–ª–µ–∫–æ –≤–Ω–∏–∑—É) –ª–µ–∂–∞—Ç –≤—ã–∂–∂–µ–Ω–Ω—ã–µ –∑–µ–º–ª–∏ –±–æ—Å—Å–∞. –ë—É–¥—å –æ—Å—Ç–æ—Ä–æ–∂–µ–Ω! üî•'
    ]
};

// –°–≤–µ—Ç–ª—è—á–∫–∏ (—á–∞—Å—Ç–∏—Ü—ã)
let particles = [];
for(let i=0; i<100; i++) {
    particles.push({
        x: Math.random() * canvas.width,
        y: Math.random() * canvas.height,
        vx: (Math.random()-0.5)*2,
        vy: (Math.random()-0.5)*2,
        size: Math.random()*2+1
    });
}

// –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
let joy = { active: false, x: 0, y: 0 };
const stick = document.getElementById('joy-stick');

document.getElementById('joy-base').addEventListener('touchstart', e => { joy.active = true; handleJoy(e); });
window.addEventListener('touchmove', e => { if(joy.active) handleJoy(e); });
window.addEventListener('touchend', () => { joy.active = false; stick.style.transform = 'translate(0,0)'; joy.x = 0; joy.y = 0; });

function handleJoy(e) {
    const rect = document.getElementById('joy-base').getBoundingClientRect();
    const bx = rect.left + 50, by = rect.top + 50;
    const t = e.touches[0];
    let dx = t.clientX - bx, dy = t.clientY - by;
    const dist = Math.min(Math.sqrt(dx*dx+dy*dy), 40);
    const angle = Math.atan2(dy, dx);
    joy.x = Math.cos(angle) * (dist/40);
    joy.y = Math.sin(angle) * (dist/40);
    stick.style.transform = `translate(${Math.cos(angle)*dist}px, ${Math.sin(angle)*dist}px)`;
}

// –î–∏–∞–ª–æ–≥–∏
let currentNPC = null;
function startTalk() {
    if(!currentNPC) return;
    document.getElementById('dialog-box').style.display = 'block';
    document.getElementById('npc-name').innerText = currentNPC.name;
    document.getElementById('npc-text').innerText = npcData[currentNPC.name][currentNPC.textIndex];
    currentNPC.textIndex = (currentNPC.textIndex + 1) % npcData[currentNPC.name].length;
}
function closeDialog() { document.getElementById('dialog-box').style.display = 'none'; }

function update() {
    if(document.getElementById('dialog-box').style.display === 'block') return;

    player.x += joy.x * player.speed;
    player.y += joy.y * player.speed;
    player.x = Math.max(0, Math.min(WORLD_SIZE, player.x));
    player.y = Math.max(0, Math.min(WORLD_SIZE, player.y));

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–ª–∏–∑–æ—Å—Ç–∏ –∫ NPC
    currentNPC = null;
    document.getElementById('talk-btn').style.display = 'none';
    entities.forEach(en => {
        let d = Math.sqrt((player.x-en.x)**2 + (player.y-en.y)**2);
        if(en.type === 'npc' && d < 60) {
            currentNPC = en;
            document.getElementById('talk-btn').style.display = 'flex';
        }
        if(en.type !== 'npc' && d < 30) {
            en.hp -= 1;
            if(en.hp <= 0) { player.gold += 50; en.x = -9999; }
        }
    });
    document.getElementById('gold').innerText = player.gold;
}

function draw() {
    ctx.clearRect(0,0,canvas.width, canvas.height);
    const camX = canvas.width/2 - player.x;
    const camY = canvas.height/2 - player.y;

    // –§–æ–Ω –±–∏–æ–º–∞
    let bgColor = player.y > 15000 ? '#2a0a0a' : (player.y < 5000 ? '#0a1a2a' : '#0a2a1a');
    ctx.fillStyle = bgColor;
    ctx.fillRect(0,0, canvas.width, canvas.height);

    // –†–∏—Å—É–µ–º —Å—É—â–Ω–æ—Å—Ç–∏
    entities.forEach(en => {
        ctx.fillStyle = en.color;
        ctx.beginPath();
        ctx.arc(en.x + camX, en.y + camY, en.size || 15, 0, Math.PI*2);
        ctx.fill();
    });

    // –°–≤–µ—Ç–ª—è—á–∫–∏
    ctx.fillStyle = "rgba(255,255,200,0.5)";
    particles.forEach(p => {
        p.x += p.vx; p.y += p.vy;
        if(p.x < 0) p.x = canvas.width; if(p.x > canvas.width) p.x = 0;
        if(p.y < 0) p.y = canvas.height; if(p.y > canvas.height) p.y = 0;
        ctx.beginPath(); ctx.arc(p.x, p.y, p.size, 0, Math.PI*2); ctx.fill();
    });

    // –ò–≥—Ä–æ–∫
    ctx.fillStyle = '#3498db';
    ctx.beginPath(); ctx.arc(canvas.width/2, canvas.height/2, 15, 0, Math.PI*2); ctx.fill();

    // –ú–∏–Ω–∏-–∫–∞—Ä—Ç–∞
    mCtx.fillStyle = 'black'; mCtx.fillRect(0,0,120,120);
    entities.forEach(en => {
        mCtx.fillStyle = en.color;
        mCtx.fillRect((en.x/WORLD_SIZE)*120, (en.y/WORLD_SIZE)*120, 4, 4);
    });
    mCtx.fillStyle = 'blue';
    mCtx.fillRect((player.x/WORLD_SIZE)*120, (player.y/WORLD_SIZE)*120, 6, 6);
}

function loop() { update(); draw(); requestAnimationFrame(loop); }
loop();
</script>
</body>
</html>
